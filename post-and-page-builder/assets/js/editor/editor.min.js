var IMHWPB=IMHWPB||{},BG=(window.BOLDGRID=window.BOLDGRID||{},BOLDGRID.EDITOR=BOLDGRID.EDITOR||{},BOLDGRID.EDITOR);IMHWPB.Editor=function(g){var m=this,i=(this.media_default_bound=!1,g(window));this.row_selector_string="",this.content_selector_string="",this.column_selector_string="",this.currently_selected_size=null,this.select_alignment=function(){var n,e,t=g(tinymce.activeEditor.selection.getNode()),i=g(".attachments-browser select.alignment"),a=g(".attachments-browser select.link-to");0==m.media_default_bound&&(m.media_default_bound=!0,wp.media.frame.on("open",m.select_alignment)),t.is("img")&&(e=[],t.attr("class")&&(e=t.attr("class").split(/\s+/)),n="none",g.each(e,function(e,t){return"aligncenter"==t?!(n="center"):"alignnone"==t?!(n="none"):"alignright"==t?!(n="right"):"alignleft"==t?!(n="left"):void 0}),e=null,t.parent("a").length||(e="none"),a.length&&e&&a.val(e).change(),i.length)&&i.val(n).change()},this.select_default_alignment=function(){g(document).on("click",".attachments-browser .attachment",m.select_alignment)},this.draggable=function(){var e=null;return e=IMHWPB.WP_MCE_Draggable&&IMHWPB.WP_MCE_Draggable.instance?IMHWPB.WP_MCE_Draggable.instance.draggable_instance:e},this.override_insert_media=function(){var l;_.isUndefined(window.send_to_editor)||(l=send_to_editor),send_to_editor=function(e){var t,n=[];if(e.match(/^\[.+?\]/)||(o=g(tinymce.activeEditor.selection.getContent()),a=(t=g(e)).is("img")||t.is("a")&&t.find("*").is("img")),a&&o.is("img")&&t.find("img").length<=1){var i=[],a=o.attr("class"),s=[],a=(a&&(s=a.split(/\s+/)),o.attr("width")),o=o.attr("height"),r=(g.each(s,function(e,t){t.match(/size-/)||t.match(/align/)||t.match(/wp-image-/)||i.push(t)}),null),s=(r=t.is("img")?t:t.find("img"),g.each(i,function(e,t){r.addClass(t)}),r.attr("height",o).attr("width",a),g(tinymce.activeEditor.selection.getNode())),o=s.parent();if((s=o.length&&"A"==o[0].tagName?o:s).replaceWith(t[0].outerHTML),tinymce.activeEditor.fire("setContent"),tinymce.activeEditor.focus(),BOLDGRID.EDITOR.mce.undoManager.add(),window.tb_remove)try{window.tb_remove()}catch(e){}}else n.push(e),l&&l.apply(this,n)}},m.select_default_alignment(),m.original_column_val=g('[name="screen_columns"]:checked').val(),tinymce.PluginManager.add("add_block_imhwpb",function(e,t){"content"===e.id&&(e.addButton("add_block_imhwpb",{title:"Add Block",classes:"button-primary gridblock-icon"}),e.buttons.fullscreen.tooltip="Fullscreen (Ctrl+Shift+F)")}),tinymce.PluginManager.add("large_view_imhwpb",function(e,t){"content"===e.id&&e.addButton("large_view_imhwpb",{title:"Large View",icon:"icon dashicons dashicons-desktop imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-large",onclick:function(e){m.activate_display("large",g(e.target))}})}),tinymce.PluginManager.add("monitor_view_imhwpb",function(e,t){"content"===e.id&&e.addButton("monitor_view_imhwpb",{title:"Desktop View",icon:"icon dashicons dashicons-laptop imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-desktop",onclick:function(e){m.activate_display("monitor",g(e.target))}})}),tinymce.PluginManager.add("tablet_view_imhwpb",function(e,t){"content"===e.id&&e.addButton("tablet_view_imhwpb",{title:"Tablet View",icon:"icon dashicons dashicons-tablet imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-tablet",onclick:function(e){m.activate_display("tablet",g(e.target))}})}),tinymce.PluginManager.add("phone_view_imhwpb",function(e,t){"content"===e.id&&e.addButton("phone_view_imhwpb",{title:"Phone View",icon:"icon dashicons dashicons-smartphone imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-phone",onclick:function(e){m.activate_display("phone",g(e.target))}})}),tinymce.PluginManager.add("toggle_draggable_imhwpb",function(d,e){"content"===d.id&&(BOLDGRID.EDITOR.mce=d,m.override_insert_media(),d.addButton("toggle_draggable_imhwpb",{title:"BoldGrid Editing",icon:"icon genericon genericon-move",classes:"widget btn",onclick:m.toggle_draggable_plugin}),d.on("NodeChange",function(e){var t=g(e.element).html();g(e.element).is("td, th")&&t.includes("<br>")&&(t=t.replace("<br>",""),g(e.element).html(t))}),d.on("AfterSetSelectionRange",function(e){var t=e.range.startContainer,e=e.range.endContainer,n=g(t).is("td, th")||0<g(t).parents("td, th").length,i=g(e).is(t),a=g(t).closest("table"),e=g(e).closest("table").is(a);!n||i||e||d.selection.select(t)}),d.on("SaveContent",function(e){var t=g("<div>"+e.content+"</div>");t.find(".td-resize-tooltip").remove(),e.content=t.html()}),d.on("BeforeAddUndo",function(e){if(1==IMHWPB.tinymce_undo_disabled)return!1;e.level.content=BG.Service.sanitize.cleanup(e.level.content)}),d.on("undo redo",function(e){BOLDGRID.EDITOR.Controls.$container&&BOLDGRID.EDITOR.Controls.$container.trigger("history_change_boldgrid"),"undefined"!=typeof IMHWPBGallery&&IMHWPBGallery.init_gallery&&IMHWPBGallery.init_gallery(g(d.iframeElement).contents())}),d.on("SetContent",function(e){m.reset_anchor_spaces(tinymce.activeEditor.getBody(),!0),m.adjust_overlay_colors(tinymce.activeEditor.getBody()),g.fourpan&&g.fourpan.refresh&&g.fourpan.refresh(),"html"==e.format&&m.dragging_is_active()&&!e.set&&IMHWPB.WP_MCE_Draggable.instance.draggable_instance.validate_markup()}),d.on("show",function(e){m.dragging_is_active()&&IMHWPB.WP_MCE_Draggable.instance.draggable_instance.validate_markup()}),d.on("KeyDown",function(e){if(m.draggable){"Escape"===e.key&&d.execCommand("mceFullScreen");var t,n,i=tinymce.activeEditor.selection.getNode(),a=g(i),s=(m.dragging_is_active()&&m.draggable.$master_container.trigger("is-typing-keydown"),a.is(m.draggable.column_selectors_string)),o=a.hasClass("bg-box"),r=a.is(m.draggable.row_selectors_string),l=a.is("A"),c=tinymce.DOM.isEmpty(i);if(o&&13==e.which&&c)return t=g("<p><br></p>"),a.append(t),d.selection.setCursorLocation(t[0],0),!1;if(s||r){if(48<=e.which&&e.which<=90||96<=e.which&&e.which<=105||13==e.which){if(!c)return;if(13==e.which){if(r||s&&m.draggable.max_row_size===m.draggable.find_column_size(a))return t=g('<div class="row"><div class="col-lg-12 col-md-12"></div></div>'),a.closest(".row").after(t),d.selection.setCursorLocation(t.find(".col-md-12")[0],0),!1;if(s)return n=g('<p><br data-mce-bogus="1"></p><p><br data-mce-bogus="1"></p>'),a.append(n),d.selection.setCursorLocation(n.last()[0],0),!1}s?t=n=g('<p><br data-mce-bogus="1"></p>'):n=(t=g('<div class="col-lg-12 col-md-12"><p><br></p></div>')).find("p"),a.html(t),d.selection.setCursorLocation(n[0],0)}}else if(!l||"8"!=e.which&&"46"!=e.which){if("P"==i.tagName){if(13==e.which&&c&&!a.find("img").length)return n=g('<p><br data-mce-bogus="1"></p>'),a.after(n),d.selection.setCursorLocation(n[0],0),!1;if("8"==e.which&&c&&(o=(o=a.prev()).length&&o.hasClass("draggable-tools-imhwpb")?o.prev():o).length)return a.remove(),tinymce.DOM.isEmpty(o[0])?d.selection.setCursorLocation(o[0],0):(d.selection.select(o[0]),d.selection.collapse(0)),!1}else if("IMG"==i.tagName||a.is(".button-primary, .button-secondary, .btn"))if(13==e.which)return n=g('<p><br data-mce-bogus="1"></p>'),((r=a.closest("p")).length?r:a).after(n),d.selection.setCursorLocation(n[0],0),!1}else if("&nbsp;&nbsp;"==a.html()||"&nbsp; "==a.html())return a.remove(),!1}return!0}),d.on("NodeChange",function(e){var t,n,i,a=g(e.element);"A"==e.element.tagName&&(t=tinymce.DOM.createRng(),n=null,(i=tinymce.activeEditor.selection.getRng()).startOffset==i.endOffset&&(0===i.startOffset?e.element.firstChild.data&&("&nbsp;"==e.element.firstChild.data.substr(0,6)||/\s/.test(e.element.firstChild.data.substr(0,1)))&&(n=1):e.element.firstChild&&i.startOffset==e.element.firstChild.length&&(i=0,e.element.firstChild.data&&("&nbsp;"==e.element.firstChild.data.substr(-6)||/\s/.test(e.element.firstChild.data.substr(-1)))&&(i=-1),n=e.element.firstChild.length+i)),n)&&(t.setStart(e.element.firstChild,n),t.setEnd(e.element.firstChild,n),tinymce.activeEditor.selection.setRng(t)),e.selectionChange&&a.length&&a.is("br")&&a.parent().children().each(function(){var e=g(this);if(e.is("a")&&e.html()&&!e.find("img").length)return($new_element=e.find(":first")).length||($new_element=e),d.selection.setCursorLocation($new_element[0],1),!1})}),d.on("SetAttrib",function(e){var t;e.attrElm.hasClass("wpview-wrap")&&void 0!==IMHWPB.WP_MCE_Draggable.instance&&(t=IMHWPB.WP_MCE_Draggable.instance.draggable_instance).resize&&t.$master_container.trigger("mouseup",e.attrElm)}),d.on("mousedown",function(e){var t,n,i;m.draggable&&(n=g(e.target),t=!0===tinymce.activeEditor.boldgridResize,i=n.closest(".draggable-tools-imhwpb").length,n=!m.draggable.ie_version&&n.hasClass("action-list")&&!n.attr("draggable"),i&&!n||t)&&(e.button=!0,e.preventDefault=function(){},(i=g("<div><div></div></div>"))[0].contentEditable=!1,e.target=i[0])}),d.on("dragstart",function(e){g(e.originalTarget).hasClass("popover-imhwpb")&&e.preventDefault()}),d.on("ObjectResizeStart",function(e){void 0!==IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container&&(IMHWPB.WP_MCE_Draggable.instance.draggable_instance.popovers_disabled=!0,IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container.find("html").addClass("bg-disabled-handles"))}),d.on("ObjectResized",function(e){void 0!==IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container&&(IMHWPB.WP_MCE_Draggable.instance.draggable_instance.popovers_disabled=!1,IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container.find("html").removeClass("bg-disabled-handles"))}),d.on("GetContent",function(e){var t=window.getUserSetting("editor_fullscreen");e.content&&(e.content=m.reset_anchor_spaces("<div>"+e.content+"</div>",!1),e.content=BG.Service.sanitize.cleanup(e.content),m.adjust_button_classes(tinymce.activeEditor.getBody()),"on"===t)&&g("#post-status-info").css({position:"fixed",bottom:-1e4})}),d.on("AddUndo",function(e){BOLDGRID.EDITOR.GRIDBLOCK.View.updateHistoryStates(),BOLDGRID.EDITOR.Service.component&&BOLDGRID.EDITOR.Service.component.validateEditor()}),d.on("init",function(e){IMHWPB.WP_MCE_Draggable.instance=new IMHWPB.WP_MCE_Draggable;var t,n,i,a=g(d.getBody()),e=g(e.target.iframeElement).contents(),s=window.getUserSetting("editor_fullscreen"),o=(BoldgridEditor.global_inline_styles&&(t=g('<style id="global-inline-styles"></style>'),n=BoldgridEditor.global_inline_styles,i=e.find("head"),t.html(n),i.append(t)),"on"===s&&d.execCommand("mceFullScreen"),BoldgridEditor.body_class&&a.addClass(BoldgridEditor.body_class),BoldgridEditor.hasDraggableEnabled?(IMHWPB.WP_MCE_Draggable.instance.load_draggable(e),m.draggable=IMHWPB.WP_MCE_Draggable.instance.draggable_instance,m.draggable.ie_version&&m.draggable.ie_version<=11&&a.addClass("dragging-disabled")):(IMHWPB.WP_MCE_Draggable.instance.draggable_inactive=!0,IMHWPB.WP_MCE_Draggable.instance.addDeactivateClasses()),[]);o.push(tinymce.ui.Factory.create({type:"button",title:"Change",tooltip:"Change",icon:"icon dashicons dashicons-admin-media imhwpb-icon",onclick:function(){BOLDGRID.EDITOR.CONTROLS.IMAGE.Change.openModal()}})),tinymce.activeEditor.on("wptoolbar",function(e){var t,n;e.toolbar&&(t=(e=e.toolbar).items()[0].items()[0],n=_.findIndex(t.items(),function(e){return"Change"==e.settings.title}),e.show(),-1===n)&&(t.insert(o,3,!1),e.reposition())}),tinymce.activeEditor.on("FullscreenStateChanged",function(e){$wpStatusbar=g("#post-status-info"),e.state?(window.setUserSetting("editor_fullscreen","on"),e=parseInt(g("#wpadminbar").css("z-index"))+1,g(window).trigger("resize"),g("#post-body-content").attr("style","position:relative;z-index:"+e+" !important;"),$wpStatusbar.css({position:"fixed",bottom:-1e4})):(window.setUserSetting("editor_fullscreen","off"),g("#post-body-content").attr("style","position:relative;"),$wpStatusbar.css({position:"unset",bottom:"unset"}))}),[g("i.mce-i-bold").parent("button").parent(".mce-widget"),g("i.mce-i-bullist").parent("button").parent(".mce-widget"),g("i.mce-i-alignleft").parent("button").parent(".mce-widget"),g("i.mce-i-link").parent("button").parent(".mce-widget"),g("i.mce-i-icon.dashicons-desktop").parent("button").parent(".mce-widget"),g("i.mce-i-strikethrough").parent("button").parent(".mce-widget")].forEach(function(e){g('<div class="mce-divider"></div>').insertBefore(g(e)),window.boldgridEditorPointers&&g(".mce-i-fullscreen").pointer(options).pointer("reposition")}),g("#wp-content-editor-container > .mce-tinymce > .mce-container-body > .mce-top-part > .mce-container-body").prepend('<div id="mce_fullscreen_actions"></div>'),g("#mce_fullscreen_actions").append(g("#wp-content-media-buttons").clone(!0)),g("#mce_fullscreen_actions").append('<div class="mce-publish-buttons"></div>'),g(".mce-publish-buttons").append(g("#minor-publishing-actions").clone(!0).prop("id","mce-minor-publishing-actions")),g(".mce-publish-buttons").append(g("#major-publishing-actions").clone(!0).prop("id","mce-major-publishing-actions")),g(".mce-publish-buttons").append('<div class="mce-close-fullscreen"><span class="dashicons dashicons-no-alt"></span></div>'),g(".mce-close-fullscreen").on("click",function(){d.execCommand("mceFullScreen")})}))}),this.mce_element_is_empty=function(e){var t=e.children(),n=!1;return n=e.is(":empty")||1==t.length&&t.filter("br").length&&!e.text()?!0:n},this.adjust_overlay_colors=function(e){var e=g(e),t=e.find("[data-bg-overlaycolor-alpha]");return($alphaBgElements=e.find("[data-alpha]")).each(function(){var e=g(this),t=e.attr("class").match(/color[\d|\-|\w]*-background-color/),n=e.attr("data-bg-uuid"),e=e.attr("data-alpha"),i=g(tinyMCE.activeEditor.iframeElement).contents().find("head");t&&(t=(t=(t="neutral"!==(t=(t=t[0].replace("color","").replace("-background-color","")).replace("-",""))?BoldgridEditor.colors.defaults[parseInt(t)-1]:BoldgridEditor.colors.neutral).replace(")",","+e+")")).replace("rgb","rgba"),i.append('<style id="'+n+'-inline-styles">body .'+n+" { "+("background-color: "+t+" !important;")+" }</style>"))}),t.each(function(){var e=g(this),t=e.data("bg-overlaycolor-class"),n=e.data("bg-overlaycolor-alpha"),i=e.data("image-url"),t="neutral"!==t?BoldgridEditor.colors.defaults[parseInt(t)-1]:BoldgridEditor.colors.neutral;t=(t=t.replace(")",","+n+")")).replace("rgb","rgba"),e.attr("data-bg-overlaycolor",t),e.css("background-image","linear-gradient(to left, "+t+", "+t+'), url("'+i+'")')}),e.html()},this.adjust_button_classes=function(e){var t,e=g(e);return e.find(".menu-item.btn").each(function(){var e=g(this);e.hasClass("button-primary")&&(e.removeClass("button-primary"),e.find("a").attr("class",BoldgridEditor.builder_config.theme_buttons.primary)),e.hasClass("button-secondary")&&(e.removeClass("button-secondary"),e.find("a").addClass("button-secondary"),e.find("a").attr("class",BoldgridEditor.builder_config.theme_buttons.secondary)),e.removeClass("btn"),e.addClass("item-has-btn"),e.removeClass(function(e,t){return(t.match(/(^|\s)btn\S+/g)||[]).join(" ")}),e.removeClass(function(e,t){return(t.match(/(^|\s)hvr-\S+/g)||[]).join(" ")}),e.find("a").addClass("btn")}),t={primary:e.find(".button-primary"),secondary:e.find(".button-secondary")},buttonClasses=BoldgridEditor.builder_config.theme_buttons,t.primary.each(function(){g(this).attr("class",buttonClasses.primary)}),t.secondary.each(function(){g(this).attr("class",buttonClasses.secondary)}),e.html()},this.reset_anchor_spaces=function(e,n){e=g(e);return e.find("a:not(.wpview a)").each(function(){var e=g(this),t=e.html();"&nbsp;"==(t="&nbsp;"==t.substr(0,6)?t.substr(6):t).substr(-6,6)&&(t=t.substr(0,t.length-6)),n?(e.hasClass("btn")||e.hasClass("button")||e.hasClass("button-primary")||e.hasClass("button-secondary")||e.hasClass("ppb-button"))&&e.html("&nbsp;"+t+"&nbsp;"):e.html(t)}),e.html()},this.dragging_is_active=function(){return void 0!==IMHWPB.WP_MCE_Draggable.instance&&0==IMHWPB.WP_MCE_Draggable.instance.draggable_inactive},this.toggle_draggable_plugin=function(e){console.log("disabled")},this.activate_display=function(e,t){var n=t.closest("div");if(n.hasClass("mce-disabled"))return!1;g(".mce-displaysize-imhwpb").removeClass("boldgrid-highlighted-mce-icon"),n.hasClass("mce-active")?(t.closest("div").removeClass("mce-active"),m.remove_editor_styles(),m.currently_selected_size=null):(g(".mce-displaysize-imhwpb").each(function(){g(this).closest("div").removeClass("mce-active")}),t.closest("div").addClass("mce-active"),m.set_width(e),m.currently_selected_size=e),IMHWPB.WP_MCE_Draggable.instance&&0==IMHWPB.WP_MCE_Draggable.instance.draggable_inactive&&(IMHWPB.WP_MCE_Draggable.instance.resize_done_event(),i.trigger("resize"))},this.remove_editor_styles=function(){g("#content_ifr").removeClass("mce-viewsize-phone-imhwpb mce-viewsize-tablet-imhwpb mce-viewsize-monitor-imhwpb mce-viewsize-large-imhwpb")},this.set_width=function(e){m.remove_editor_styles(),g("#content_ifr").addClass("mce-viewsize-"+e+"-imhwpb")}},IMHWPB.Editor.instance=new IMHWPB.Editor(jQuery);