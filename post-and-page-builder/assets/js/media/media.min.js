var IMHWPB=IMHWPB||{};IMHWPB.Media=function(s){var d=this;this.search_params="",this.location="",s(function(){d.on_page_load()}),this.on_page_load=function(){void 0!==IMHWPB.Globals&&IMHWPB.Globals.isIframe&&d.iframe_onload()},this.build_tabs=function(e){var i="";return s.each(e,function(e,t){t.content[0]&&(i+='<a class="media-menu-item" data-tabname="'+e+'" href="#">'+t.name+"</a>")}),i},this.handle_iframe_load=function(e){var t=s(".media-router"),i=s(".media-toolbar-primary"),a=s(".media-selection");s(".media-frame").removeClass("hide-toolbar hide-router"),t.html(d.build_tabs(e)),i.html('<a href="#" class="button media-button button-primary button-primary-disabled button-large">Insert into page</a>'),a.addClass("empty"),d.setup_top_tab_nav(),d.register_tab_click_events(),d.insert_to_page_event()},this.setup_top_tab_nav=function(){s(".media-menu-item").on("click",function(){s(this).parent().find(".media-menu-item").removeClass("active"),s(this).addClass("active")})},this.register_tab_click_events=function(){s(".media-router .media-menu-item").on("click",function(){s(".media-iframe iframe")[0].contentWindow.IMHWPB.Media.instance.enable_iframe_content(s(this).data("tabname"))}),s(".media-router .media-menu-item:first").click()},this.sendGridblock=function(e){var t,i,a,n,d=!1;return e&&IMHWPB.WP_MCE_Draggable.draggable_instance&&(t=IMHWPB.WP_MCE_Draggable.draggable_instance,i=tinymce.activeEditor,a=s(i.selection.getNode()),n=e.is(t.row_selectors_string)?t.row_selectors_string:t.sectionSelectorString,e.is(n))&&((a=a.closest(n)).length?a.before(e):(n==t.row_selectors_string&&s(i.getBody()).find(".boldgrid-section").length?s(i.getBody()).find(".boldgrid-section:first > .container, .boldgrid-section:first > .container-fluid"):s(i.getBody())).prepend(e),t.validate_markup(),i.fire("setContent"),i.focus(),d=!0,setTimeout(function(){BOLDGRID.EDITOR.CONTROLS.Add.scrollToElement(e,0)})),d},this.insert_to_page_event=function(){s(".media-toolbar .media-button").on("click",function(e){var a,t;e.preventDefault(),0==s(this).hasClass("button-primary-disabled")&&(e=function(e){a.uncheck_all(),s(".media-modal-close").click();var t=e.match(/^\[.+\]$/),i=null;0!=t&&null!=t||(i=s(e)),d.sendGridblock(i)||send_to_editor(e),s(window).trigger("resize")},"string"!=typeof(t=(a=s(".media-iframe iframe")[0].contentWindow.IMHWPB.Media.instance).find_selected_elements())?t.always(e):e(t))})},this.toggle_insert_button=function(e){var t=s(".media-toolbar").find(".button");!0===e?t.removeClass("button-primary-disabled"):!1===e&&t.addClass("button-primary-disabled")},this.find_current_location=function(){"object"==typeof navigator&&"object"==typeof navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){d.location={ll:[e.coords.latitude,e.coords.longitude].join(",")}})},this.iframe_onload=function(){var e=null;switch(IMHWPB.Globals["tab-details"].type){case"api":e=d.find_api_content,d.bind_search_form(),d.find_current_location();break;case"html":e=d.insert_image;break;case"shortcode-form":e=d.insert_markup,d.bind_checkbox_selections()}parent.IMHWPB.Media.instance.handle_iframe_load(IMHWPB.Globals.tabs),d.disable_insert_button(),d.prevent_attachment_content_actions(),d.register_sidebar_event_handlers(),d.register_attachment_click_events(e,IMHWPB.Globals["tab-details"]["selection-type"]),"shortcode-form"===IMHWPB.Globals["tab-details"].type&&d.preselect_form(),d.translate_image_urls()},this.prevent_attachment_content_actions=function(){s(".centered-content-boldgrid").on("click","button, a",function(){return!1})},this.preselect_form=function(){parent.jQuery(parent).on("boldgrid_edit_form",function(e,t){d.select_form_action(t)}),void 0!==parent.IMHWPB.editform&&parent.IMHWPB.editform&&d.select_form_action(parent.IMHWPB.editform)},this.select_form_action=function(e){var e=e.shortcode.attrs.named,t=s(".media-sidebar-boldgrid"),i=t.find("#title-toggle-boldgrid"),a=t.find("#description-enable-boldgrid"),n=t.find("#ajax-enable-boldgrid"),i=(d.deselect_all_attachments(),d.preselect_checkbox(i,e.title),d.preselect_checkbox(a,e.description),d.preselect_checkbox(n,e.ajax),t.find("#tabindex-wrapper-boldgrid"));e.tabindex?(i.find("input").val(e.tabindex),i.removeClass("hidden")):(i.find("input").val(""),i.addClass("hidden")),s('[data-form-id-boldgrid="'+e.id+'"]').find(".attachment-preview").click()},this.preselect_checkbox=function(e,t){e.length&&("true"===t?(e.val(!0),e.prop("checked",!0)):(e.val(!1),e.prop("checked",!1)))},this.bind_checkbox_selections=function(){var e=s(".media-sidebar-boldgrid");e.on("submit","form",function(){return!1}),e.find("#title-toggle-boldgrid").on("click",function(){d.set_sidebar_title_visibility()}),e.find("#description-enable-boldgrid").on("click",function(){d.set_sidebar_description_visibility()})},this.set_sidebar_title_visibility=function(){var e=s(".media-sidebar-boldgrid").find(".wpforms-title");s("#title-toggle-boldgrid").prop("checked")?e.show():e.hide()},this.set_sidebar_description_visibility=function(){var e=s(".media-sidebar-boldgrid").find(".wpforms-description");s("#description-enable-boldgrid").prop("checked")?e.show():e.hide()},this.register_sidebar_event_handlers=function(){s('.media-sidebar-boldgrid a[title="advanced-options"]').on("click",function(e){e.preventDefault(),s("#tabindex-wrapper-boldgrid").toggleClass("hidden")})},this.disable_insert_button=function(){s(".media-sidebar img, .media-sidebar iframe").on("load",function(){s(this).attr("src")?parent.IMHWPB.Media.instance.toggle_insert_button(!0):parent.IMHWPB.Media.instance.toggle_insert_button(!1)})},this.perform_search=function(){d.search_params={q:s('input[name="map-search-imhwpb"]').val()},d.find_api_content(s(".attachment.selected"))},this.bind_search_form=function(){s("#search-map-imhwpb").on("submit",function(e){e.preventDefault(),d.perform_search()}),s(".media-sidebar .searchbutton").on("click",function(){d.perform_search()}),s('#search-map-imhwpb select[name="select-size-imhwpb"]').on("change",function(){"custom"==s(this).val()?s("#map-dimensions-imhwpb").removeClass("hidden"):s("#map-dimensions-imhwpb").addClass("hidden"),d.update_map_size()})},this.update_map_size=function(){var e=s(".media-sidebar .boldgrid-google-map"),t=d.find_selected_map_size();e.attr("data-width",t.width).attr("data-height",t.height)},this.enable_iframe_content=function(e){s(".attachments").addClass("hidden"),s('.attachments[data-tabname="'+e+'"]').removeClass("hidden")},this.translate_image_urls=function(){s('[data-tabname="basic-gridblocks"] [data-boldgrid-asset-id]').each(function(){var e=s(this),t=e.data("boldgrid-asset-id");IMHWPB.configs&&IMHWPB.configs.api_key?(t=IMHWPB.configs.asset_server+IMHWPB.configs.ajax_calls.get_asset+"?key="+IMHWPB.configs.api_key+"&id="+t,e.attr("src",t),e.attr("data-pending-boldgrid-attribution",1)):IMHWPB.Media.GridBlocks.swap_image_with_placeholder(e)})},this.get_map_html=function(){var e=s(".media-sidebar iframe"),t=s("<iframe>"),i=s("<p>").addClass("boldgrid-google-maps");return t.attr("frameborder",0).attr("width",e.attr("data-width")).attr("height",e.attr("data-height")).attr("src",e.attr("src")).css("max-width","100%"),i.html(t),i[0].outerHTML},this.find_selected_elements=function(){var e="";switch(IMHWPB.Globals["tab-details"].type){case"html":e=IMHWPB.Media.GridBlocks.get_selected_html();break;case"api":e=d.get_map_html();break;case"shortcode-form":var t=s('.attachment[aria-checked="true"]').data("form-id-boldgrid"),e=d.create_form_shortcode(t)}return e},this.create_form_shortcode=function(e){var t,i=s(".media-sidebar-boldgrid"),a=i.find("#title-toggle-boldgrid").prop("checked"),n=i.find("#description-enable-boldgrid").prop("checked");i.find("#ajax-enable-boldgrid").prop("checked"),t=i.find("#tabindex-wrapper-boldgrid input").val();return'[wpforms id="'+e+'"'+(n?' description="true"':' description="false"')+(a?' title="true"':' title="false"')+"]"},this.uncheck_all=function(){s('.attachment[aria-checked="true"]').each(function(){s(this).attr("aria-checked",!1),s(this).removeClass("details selected"),s(".media-sidebar > div").addClass("hidden")})},this.find_selected_map_size=function(){var e=s(".media-sidebar"),t=e.find('select[name="select-size-imhwpb"]'),i=t.find("option:selected"),a=i.data("width"),i=i.data("height");return"custom"==t.val()&&(a=e.find('input[name="custom-width-imhwpb"]').val(),i=e.find('input[name="custom-height-imhwpb"]').val()),{width:a,height:i}},this.find_api_content=function(e){var t=e.closest(".attachments").data("tabname"),t=IMHWPB.Globals.tabs[t].content[e.data("id")]["map-params"],e=(d.find_selected_map_size(),d.search_params.q&&IMHWPB.Globals["tab-details"]["default-location-setting"]!=d.search_params||(d.location?d.search_params=d.location:d.search_params=IMHWPB.Globals["tab-details"]["default-location-setting"]),IMHWPB.Globals["tab-details"]["base-url"]+"?"+s.param(s.extend(d.search_params,t,{output:"embed"})));d.update_map_size(),d.image_replacement(e)},this.insert_image=function(e){var t;"raw"!=e.data("html-type")?(t=e.find("img").attr("src"),d.image_replacement(t)):(d.image_replacement(""),t=s(".media-sidebar"),e=e.find(".centered-content-boldgrid").html(),t.find(".centered-content-boldgrid").html("<div>"+e+"</div>"),t.find(".fullwidth-imhwpb").addClass("hidden"),t.find("> div").removeClass("hidden"),e=t.find(".centered-content-boldgrid > div")[0].getBoundingClientRect().height,s(".boldgrid-markup-container").css({height:parseInt(e)+15+"px"}),parent.IMHWPB.Media.instance.toggle_insert_button(!0))},this.insert_markup=function(e){var t=s(".media-sidebar"),i=e.find(".centered").html(),i=(s(".boldgrid-markup-container").html(i),t.find("> div").removeClass("hidden"),t.find(".wpforms-container")[0].getBoundingClientRect().height),t=(s(".boldgrid-markup-container").css({height:parseInt(i)+15+"px"}),e.data("form-id-boldgrid"));d.insert_edit_link(t),d.set_sidebar_title_visibility(),d.set_sidebar_description_visibility(),parent&&parent.IMHWPB.Media.instance.toggle_insert_button(!0)},this.insert_edit_link=function(e){e=IMHWPB.Globals["admin-url"]+"admin.php?page=wpforms-builder&view=fields&form_id="+e;$media_sidebar=s(".media-sidebar").find(".editform-link a:first").attr("href",e)},this.image_replacement=function(e){var t=s(".media-sidebar");t.find(".centered-content-boldgrid").empty(),t.find("img.fullwidth-imhwpb, iframe.fullwidth-imhwpb").attr("src",e).removeClass("hidden"),t.find("> div").removeClass("hidden")},this.deselect_attachment=function(e){1==e.hasClass("selected")&&(e.removeClass("selected"),e.attr("aria-checked",!1),e.removeClass("details"))},this.deselect_all_attachments=function(){s(".attachment").each(function(){d.deselect_attachment(s(this))})},this.register_attachment_click_events=function(t,i){s(document).on("click",".attachment",function(){var e=s(this).closest(".attachment");"single-item"==i&&d.deselect_all_attachments(),s(".attachment").removeClass("details"),e.addClass("details"),0==e.hasClass("selected")&&(e.addClass("selected"),e.attr("aria-checked",!0)),t(e)}),s(document).on("click",'.check[title="Deselect"]',function(e){e.stopPropagation();e=s(this).closest(".attachment");d.deselect_attachment(e),s(".media-sidebar > div").addClass("hidden"),0==s(".attachment.selected").length&&parent.IMHWPB.Media.instance.toggle_insert_button(!1)})}},IMHWPB.Media.instance=new IMHWPB.Media(jQuery);