(globalThis.webpackChunkwebpack=globalThis.webpackChunkwebpack||[]).push([[583],{56989:(e,i,t)=>{"use strict";t.r(i),t.d(i,{Connection:()=>v,buildConnectionForCheckingAvailability:()=>a,default:()=>h});var o=t(56666),s=t(34386),n=t.n(s),r=t(17768),c=t.n(r);const l=n()("calypso:happychat:connection");class v{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];(0,o.Z)(this,"receiveAccept",void 0),(0,o.Z)(this,"receiveConnect",void 0),(0,o.Z)(this,"receiveDisconnect",void 0),(0,o.Z)(this,"receiveError",void 0),(0,o.Z)(this,"receiveInit",void 0),(0,o.Z)(this,"receiveLocalizedSupport",void 0),(0,o.Z)(this,"receiveMessage",void 0),(0,o.Z)(this,"receiveHappychatEnv",void 0),(0,o.Z)(this,"receiveMessageOptimistic",void 0),(0,o.Z)(this,"receiveMessageUpdate",void 0),(0,o.Z)(this,"receiveReconnecting",void 0),(0,o.Z)(this,"receiveStatus",void 0),(0,o.Z)(this,"receiveToken",void 0),(0,o.Z)(this,"receiveUnauthorized",void 0),(0,o.Z)(this,"requestTranscript",void 0),(0,o.Z)(this,"closeAfterAccept",void 0),(0,o.Z)(this,"dispatch",void 0),(0,o.Z)(this,"openSocket",void 0),Object.assign(this,e),this.closeAfterAccept=i}init(e,i){if(this.openSocket)return l("socket is already connected"),this.openSocket;const t=i=>{if(i)return e(i)};return this.dispatch=t,this.openSocket=new Promise(((e,o)=>{i.then((i=>{let{url:s,user:{signer_user_id:n,jwt:r,groups:l,skills:v,geoLocation:a}}=i;var h,d;"string"==typeof s&&(s.includes("staging")?t(null===(h=this.receiveHappychatEnv)||void 0===h?void 0:h.call(this,"staging")):t(null===(d=this.receiveHappychatEnv)||void 0===d?void 0:d.call(this,"production")));const u=(e=>"string"==typeof e?new(c())(e,{transports:["websocket"]}):e)(s);return u.once("connect",(()=>{var e;return t(null===(e=this.receiveConnect)||void 0===e?void 0:e.call(this))})).on("token",(e=>{var i;t(null===(i=this.receiveToken)||void 0===i?void 0:i.call(this)),e({signer_user_id:n,jwt:r,groups:l,skills:v})})).on("init",(()=>{var i,o;t(null===(i=this.receiveInit)||void 0===i?void 0:i.call(this,{signer_user_id:n,groups:l,skills:v,geoLocation:a})),t(null===(o=this.requestTranscript)||void 0===o?void 0:o.call(this)),e(u)})).on("unauthorized",(()=>{var e;u.close(),t(null===(e=this.receiveUnauthorized)||void 0===e?void 0:e.call(this,"User is not authorized")),o("user is not authorized")})).on("disconnect",(e=>{var i;return t(null===(i=this.receiveDisconnect)||void 0===i?void 0:i.call(this,e))})).on("reconnecting",(()=>{var e;return t(null===(e=this.receiveReconnecting)||void 0===e?void 0:e.call(this))})).on("status",(e=>{var i;return t(null===(i=this.receiveStatus)||void 0===i?void 0:i.call(this,e))})).on("accept",(e=>{var i;t(null===(i=this.receiveAccept)||void 0===i?void 0:i.call(this,e)),this.closeAfterAccept&&u.close()})).on("localized-support",(e=>{var i;return t(null===(i=this.receiveLocalizedSupport)||void 0===i?void 0:i.call(this,e))})).on("message",(e=>{var i;return t(null===(i=this.receiveMessage)||void 0===i?void 0:i.call(this,e))})).on("message.optimistic",(e=>{var i;return t(null===(i=this.receiveMessageOptimistic)||void 0===i?void 0:i.call(this,e))})).on("message.update",(e=>{var i;return t(null===(i=this.receiveMessageUpdate)||void 0===i?void 0:i.call(this,e))})).on("reconnect_attempt",(()=>{u.io.opts.transports=["polling","websocket"]}))})).catch((e=>o(e)))})),this.openSocket}send(e){if(this.openSocket)return this.openSocket.then((i=>i.emit(e.event,e.payload)),(i=>{var t,o;return null===(t=this.dispatch)||void 0===t||t.call(this,null===(o=this.receiveError)||void 0===o?void 0:o.call(this,"failed to send "+e.event+": "+i)),Promise.reject(i)}))}request(e,i){if(this.openSocket)return this.openSocket.then((t=>{const o=Promise.race([new Promise(((i,o)=>{t.emit(e.event,e.payload,((e,t)=>e?o(new Error(e)):i(t)))})),new Promise(((e,t)=>setTimeout((()=>t(new Error("timeout"))),i)))]);return o.then((i=>{var t,o;return null===(t=this.dispatch)||void 0===t?void 0:t.call(this,null===(o=e.callback)||void 0===o?void 0:o.call(e,i))}),(i=>{var t,o;"timeout"!==i.message&&(null===(t=this.dispatch)||void 0===t||t.call(this,null===(o=this.receiveError)||void 0===o?void 0:o.call(this,e.event+" request failed: "+i.message)))})),o}),(i=>{var t,o;return null===(t=this.dispatch)||void 0===t||t.call(this,null===(o=this.receiveError)||void 0===o?void 0:o.call(this,"failed to send "+e.event+": "+i)),Promise.reject(i)}))}}const a=e=>new v(e,!1),h=e=>new v(e)},18864:()=>{}}]);
//# sourceMappingURL=async-load-calypso-lib-happychat-connection.min.js.map